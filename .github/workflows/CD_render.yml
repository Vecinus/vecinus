# ----------------------------------------------------------------------------
# CD – Deploy to Render
# Triggered on every push to a release/sprintX branch.
#
# Workflow:
#   1. Resolves the sprint identifier from the branch name (e.g. "sprint1").
#   2. Runs the backend test suite (pytest) against a PostgreSQL 15 service.
#   3. Deploys Backend + Frontend to Render via Deploy Hook URLs stored as
#      secrets inside the corresponding GitHub Environment.
#
# GitHub Environments required (Settings → Environments):
#   - sprint1, sprint2, sprint3, ppl  (one per active sprint / entorno)
#   Each environment must define these secrets:
#     • RENDER_BACKEND_DEPLOY_HOOK_URL
#     • RENDER_FRONTEND_DEPLOY_HOOK_URL
# ----------------------------------------------------------------------------

name: Deploy to Render

on:
  push:
    branches:
      - "release/*"
  pull_request:
    branches:
      - "release/*"

jobs:
  # ---- 0. Resolve environment from branch name ----
  resolve-env:
    name: Resolve Sprint Environment
    runs-on: ubuntu-24.04
    outputs:
      env_name: ${{ steps.extract.outputs.env_name }}
    steps:
      - name: Extract sprint from branch
        id: extract
        run: |
          # refs/heads/release/sprint1 → sprint1
          # refs/heads/release/ppl     → ppl
          BRANCH="${GITHUB_REF#refs/heads/release/}"
          echo "Detected environment: $BRANCH"
          echo "env_name=$BRANCH" >> "$GITHUB_OUTPUT"

  # ---- 1. Backend Tests ----
  testing:
    name: Run Backend Tests
    runs-on: ubuntu-24.04

    env:
      POSTGRES_USER: vecinus_user
      POSTGRES_PASSWORD: vecinus_password
      POSTGRES_DB: vecinus_test_db
      POSTGRES_HOST: 127.0.0.1
      POSTGRES_PORT: 5432
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: vecinus_user
          POSTGRES_PASSWORD: vecinus_password
          POSTGRES_DB: vecinus_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest httpx pytest-asyncio

      - name: Run Tests
        run: |
          cd backend
          pytest

  # ---- 2. Deploy to Render ----
  deploy:
    name: Deploy to Render (${{ needs.resolve-env.outputs.env_name }})
    needs: [resolve-env, testing]
    runs-on: ubuntu-24.04
    environment: ${{ needs.resolve-env.outputs.env_name }}

    steps:
      - name: Deploy Backend
        run: |
          curl -sf "${{ secrets.RENDER_BACKEND_DEPLOY_HOOK_URL }}" \
            && echo "✓ Backend deploy triggered" \
            || { echo "✗ Backend deploy failed"; exit 1; }

      - name: Deploy Frontend
        run: |
          curl -sf "${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK_URL }}" \
            && echo "✓ Frontend deploy triggered" \
            || { echo "✗ Frontend deploy failed"; exit 1; }
